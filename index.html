<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ENERGY USED TO PRODUCE £1m GVA by GB LOCAL AUTHORITY (2015-2023)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
  <!-- Leaflet + PapaParse (defer) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer crossorigin="anonymous"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js" defer></script>

  <style>
    :root { --bg:#0b0f19; --panel:#212F47; --text:#e8ecf3; --muted:#c3ccda; --accent:#4f8cff; --border:#2f3e5b; }
 html, body {
  height: 100%;
  margin: 0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* --- Header: restore style --- */
header {
  grid-column: 1 / -1;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--panel);         /* your navy #212F47 */
  display: flex;
  align-items: center;
  gap: 12px;
}
header h1 {
  margin: 0;
  font-weight: 800;
  font-size: 22px;                  /* restore size */
  letter-spacing: .5px;
  text-transform: uppercase;        /* BIG CAPS */
  color: var(--text);               /* ensure visible on navy */
}
.brand { display: flex; align-items: center; gap: 12px; }
.brand img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,.08); object-fit: cover; }
.brand .sub { color: var(--muted); font-size: 12px; }

/* --- KPI: restore “Year” box look --- */
.kpis {
  display: grid;
  grid-template-columns: 1fr;       /* one KPI since you removed Matched */
  gap: 10px;
  margin-bottom: 8px;
}
.kpi {
  background: #0e1424;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px 10px;
}
.kpi .l {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 4px;
}
.kpi .v {
  font-size: 18px;                  /* bump for emphasis */
  font-weight: 700;
  color: var(--text);
}

#app {
  display: grid;
  grid-template-columns: 360px 1fr;   /* widened sidebar */
  grid-template-rows: auto 1fr;
  height: 100%;
}

/* Ensure the map container actually has height */
main { position: relative; }
#map { height: 100%; width: 100%; min-height: 400px; }

/* Sidebar */
aside {
  border-right: 1px solid var(--border);
  background: var(--panel);
  padding: 14px;
  overflow-y: auto;
  overflow-x: hidden;                 /* no horizontal scroll */
}

/* Header (unchanged from yours) */
header { grid-column: 1 / -1; padding: 10px 16px; border-bottom: 1px solid var(--border); background: var(--panel); display: flex; align-items: center; gap: 12px; }
header h1 { font-size: 22px; letter-spacing: .5px; font-weight: 800; margin: 0; text-transform: uppercase; }
.brand { display: flex; align-items: center; gap: 12px; }
.brand img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,.08); object-fit: cover; }
.brand .sub { color: var(--muted); font-size: 12px; }

/* Controls */
.group { margin-bottom: 16px; }
.group label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }

input[type="range"],
input[type="number"],
button,
select {
  width: 100%;
  max-width: 100%;        /* never wider than sidebar */
  box-sizing: border-box;
  background: #0e1424;
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 10px;
  font-size: 14px;
}
    .legend{position:absolute;bottom:16px;right:16px;background:rgba(20,26,42,.96);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;font-size:12px;line-height:1.2;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:1000;pointer-events:none}
    .legend .row{display:flex;align-items:center;gap:8px;margin:4px 0}
    .swatch{width:16px;height:12px;border-radius:2px;border:1px solid rgba(255,255,255,.1)}
    .tooltip{background:rgba(20,26,42,.96);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;font-size:12px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .note{font-size:12px;color:var(--muted)}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px}
    .kpi{background:#0e1424;border:1px solid var(--border);border-radius:12px;padding:8px 10px}
    .kpi .v{font-size:16px;font-weight:600}
    .row-inline{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="brand">
        <img src="/data/logo.png" alt="logo" />
        <div>
          <h1>ENERGY USED TO PRODUCE £1m GVA BY GB LOCAL AUTHORITY (2015-2023)</h1>
          <div class="sub">ONS LAD 2023&#160;·&#160;interactive choropleth</div>
        </div>
      </div>
    </header>

   <aside>
  <div class="group kpis">
    <div class="kpi">
      <div class="l">Year</div>
      <div class="v" id="kpi-year">—</div>
    </div>
  </div>

  <div class="group">
    <label>Year</label>
    <input id="yearRange" type="range" min="2015" max="2025" step="1" value="2023"/>
    <input id="yearInput" type="number" min="2015" max="2025" step="1" value="2023" style="margin-top:6px;"/>
  </div>

  <div class="group">
  <label>Metric</label>
  <select id="metricMode">
    <option value="total" selected>Total GHG (CO₂e)</option>
    <option value="co2">CO₂</option>
    <option value="ch4">CH₄</option>
    <option value="n2o">N₂O</option>
  </select>
</div>


  <div class="group row-inline">
    <button id="playBtn" class="primary" style="flex:1;">▶ Play year</button>
    <button id="fitBtn" class="primary" style="flex:1;">Reset map</button>
  </div>
</aside>


    <main style="position:relative;">
      <div id="map"></div>
      <div id="legend" class="legend"></div>
    </main>
  </div>

  <script defer>
  // Config
  const GEOJSON_URL = '/data/lad_2023.geojson';
  const CSV_URL = '/data/data.csv';
  const CODE_PROP = 'LAD23CD';
  const NAME_PROP = 'LAD23NM';
  const CSV_CODE = 'CODE';
  const CSV_YEAR = 'YEAR';
  const CSV_VALUE = 'VALUE';

  const PALETTE = ['#eef3ff','#d9e4ff','#bcd0ff','#98b8ff','#719bff','#4f80ff','#2a63ff','#1249ef'];
  const NO_DATA_FILL = '#3a4258';

  let map, layer, geo, dataRows = [], year = 2023, metricMode = 'ktoe', timer = null, yearBounds = [2015,2025];

  // NEW: fixed breaks across all years
  let globalBreaks = [];
  function computeGlobalBreaks() {
    if (!dataRows.length) { globalBreaks = []; return; }
    const all = [];
    for (const r of dataRows) {
      const v = toMetric(+r[CSV_VALUE]);
      if (Number.isFinite(v)) all.push(v);
    }
    globalBreaks = getQuantileBreaks(all, PALETTE.length);
  }

  function init(){
    map = L.map('map', {
      preferCanvas: true,
      zoomControl: true,
      zoomSnap: 0.25,
      zoomDelta: 0.5
    }).setView([54.5, -3], 6);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution:'&copy; OpenStreetMap, &copy; CARTO' }).addTo(map);

    document.getElementById('fitBtn').addEventListener('click', fitUK);
    document.getElementById('playBtn').addEventListener('click', togglePlay);
    document.getElementById('metricMode').addEventListener('change', e=>{
      metricMode = e.target.value;
      computeGlobalBreaks();     // recompute fixed scale when unit changes
      render();
    });

    const yrRange = document.getElementById('yearRange');
    const yrInput = document.getElementById('yearInput');
    yrRange.addEventListener('input', e=>{ year = +e.target.value; yrInput.value = year; render(); });
    yrInput.addEventListener('input', e=>{ year = +e.target.value; yrRange.value = year; render(); });

    loadGeo();
    loadCsv();
  }

  async function loadGeo(){
    const res = await fetch(GEOJSON_URL, { cache:'no-store' });
    if(!res.ok) throw new Error('GeoJSON fetch failed: '+res.status);
    geo = await res.json();
    if(layer) layer.remove();
    layer = L.geoJSON(geo, { style: baseStyle, onEachFeature: bindFeature }).addTo(map);
    fitUK();
    render();
  }

  function loadCsv(){
    Papa.parse(CSV_URL, { download:true, header:true, dynamicTyping:true, skipEmptyLines:true,
      complete: (results)=>{
        dataRows = (results.data||[]).filter(r=> r[CSV_CODE]!=null && r[CSV_YEAR]!=null);
        if(dataRows.length){
          const yrs = [...new Set(dataRows.map(r=>+r[CSV_YEAR]))].filter(x=>Number.isFinite(x)).sort((a,b)=>a-b);
          if(yrs.length){
            yearBounds = [Math.min(...yrs), Math.max(...yrs)];
            const [minY,maxY] = yearBounds; const yrRange = document.getElementById('yearRange'); const yrInput = document.getElementById('yearInput');
            yrRange.min=minY; yrRange.max=maxY; yrInput.min=minY; yrInput.max=maxY;
            if(+yrRange.value<minY || +yrRange.value>maxY){ yrRange.value=minY; yrInput.value=minY; year=minY; }
          }
        }
        computeGlobalBreaks();    // NEW: set fixed scale once data are in
        render();
      }, error: (err)=>{ console.error(err); alert('CSV load failed'); }
    });
  }

  function baseStyle(){ return { color:'#1e2a44', weight:0.6, fillColor:NO_DATA_FILL, fillOpacity:0.9 } }

  function bindFeature(f, l){
    l.on({ mouseover: onHover, mouseout: onOut, click: ()=> map.fitBounds(l.getBounds(), { maxZoom:9 }) });
    l._currentFill = NO_DATA_FILL;
  }

  function onHover(e){ const l=e.target; l.setStyle({ weight:2, color:'#ffffff', fillColor:l._currentFill, fillOpacity:1 }); if(l.openTooltip) l.openTooltip(); }
  function onOut(e){ const l=e.target; l.setStyle({ weight:0.6, color:'#1e2a44', fillColor:l._currentFill, fillOpacity:0.9 }); }

  function getYearValues(y){ const m=new Map(); for(const r of dataRows){ if(+r[CSV_YEAR]===+y){ m.set(String(r[CSV_CODE]).trim(), +r[CSV_VALUE]); } } return m; }

  function getQuantileBreaks(values, k=PALETTE.length){
    const v=values.filter(x=>Number.isFinite(x)).slice().sort((a,b)=>a-b);
    if(!v.length) return [];
    const qs=[];
    for(let i=0;i<=k;i++){ const p=i/k; const idx=Math.floor(p*(v.length-1)); qs.push(v[idx]); }
    return qs;
  }

  function toMetric(val){ if(!Number.isFinite(val)) return val; return metricMode==='gwh' ? val*11.63 : val; }
  function metricLabel(){ return metricMode==='gwh' ? 'GWh per £1m GVA' : 'ktoe per £1m GVA'; }

  function colorFor(val, breaks){
    if(!Number.isFinite(val) || !breaks.length) return NO_DATA_FILL;
    for(let i=0;i<PALETTE.length;i++){ if(val<=breaks[i+1]) return PALETTE[i]; }
    return PALETTE[PALETTE.length-1];
  }

  function render(){
    if(!map || !layer || !geo) return;
    document.getElementById('kpi-year').textContent = year;

    // Ensure fixed breaks exist (in case render fires before CSV finished)
    if (!globalBreaks.length) computeGlobalBreaks();
    const breaks = globalBreaks;

    const yrValsRaw = getYearValues(year);

    layer.eachLayer(l=>{
      const f=l.feature; const code=String(f.properties[CODE_PROP]).trim(); const name=String(f.properties[NAME_PROP]);
      const v = toMetric(yrValsRaw.get(code));
      const fill = colorFor(v, breaks);
      l._currentFill = fill;
      l.setStyle({ fillColor: fill });
      const valTxt = Number.isFinite(v)? v.toFixed(3) : 'No data';
      l.bindTooltip(`<div><strong>${name}</strong><br/><span class="note">${code}</span><br/>${metricLabel()}: <strong>${valTxt}</strong></div>`, { sticky:true, opacity:0.95, className:'tooltip' });
    });

    updateLegend(breaks);
  }

  function updateLegend(breaks){
    const el=document.getElementById('legend');
    let html = `<div style="margin-bottom:6px;font-weight:700;text-transform:uppercase;">${metricLabel()} (fixed scale, 2015–2023)</div>`;
    if(!breaks.length){ html += `<div class="row"><span class="swatch" style="background:${NO_DATA_FILL}"></span> No data</div>`; el.innerHTML=html; return; }
    for(let i=0;i<PALETTE.length;i++){
      const a=breaks[i], b=breaks[i+1]; if(a==null || b==null) continue;
      html += `<div class="row"><span class="swatch" style="background:${PALETTE[i]}"></span> ${fmt(a)} – ${fmt(b)}</div>`;
    }
    html += `<div class="row"><span class="swatch" style="background:${NO_DATA_FILL}"></span> No data</div>`;
    el.innerHTML = html;
  }

  function fmt(x){ return Number.isFinite(x)? x.toFixed(3) : '—'; }

  function fitUK() {
    if (!layer) return;
    const bounds = layer.getBounds();
    const tight = bounds.pad(-0.05);   // slightly tighter framing
    map.fitBounds(tight, { padding: [20, 20] });
  }

  function togglePlay(){
    const btn = document.getElementById('playBtn');
    if(timer){ clearInterval(timer); timer = null; btn.textContent = '▶ Play year'; return; }
    btn.textContent = '⏸ Pause';
    const [minY, maxY] = yearBounds;
    timer = setInterval(()=>{
      year = (year >= maxY) ? minY : (year + 1);
      document.getElementById('yearRange').value = year;
      document.getElementById('yearInput').value = year;
      render();
    }, 1200);
  }

  window.addEventListener('DOMContentLoaded', init);
</script>
